# Repository Guidelines

## プロジェクト概要
- Rust 1.90 で実装するコンソール向けモンスター育成ゲーム。  
- 主要シーンの節目でミニゲームが発生し、端末入出力を通じてプレイする。  

## モジュール構成
| モジュール | 役割 |
| --- | --- |
| `src/main.rs` | エントリーポイント。ゲーム全体の初期化とシーケンス制御を行う。 |
| `src/game` | シーン・モンスター定義などゲーム固有ロジック。 |
| `src/core` | 端末入出力やリアクティブ制御など共通基盤。`src/core/rx.rs`にテスト構成例あり。 |

- 各モジュールファイル末尾の `#[cfg(test)] mod tests` にユニットテストを配置する。
- 生成物は `target/` 配下に出力され `.gitignore` 済み。誤ってステージングしない。
- Docker 実行が必要な場合はリポジトリ直下の `Dockerfile` を利用する。

## 開発コマンド
- `cargo run` : ゲームを起動しシーン遷移や入出力を確認。  
- `cargo test` : すべてのユニットテストを実行し、`src/core/rx.rs` などの挙動を保証。  
- `cargo fmt --all` / `cargo clippy --all-targets --all-features` : フォーマットと静的解析でCIエラーを予防。  
- `docker build -t monster-trainer .` : 配布用バイナリを含むコンテナイメージを生成。  

## コーディングスタイル
- Rust 2024 エディションかつ `rustfmt` デフォルト (4スペース) を前提にする。  
- 命名規則: モジュール/ファイル=`snake_case`、型・構造体=`PascalCase`、関数/変数=`snake_case`、定数=`SCREAMING_SNAKE_CASE`。  
- 公開 API は `///` コメントで振る舞いを説明し、副作用を伴う処理には1行コメントで理由を記す。  
- `matches!` を活用し `match` の可読性を高める。所有権共有は参照優先で、`Rc`/`Arc` や `RefCell` は本当に必要な場合のみ。  
- `dyn Trait` は `Box<dyn Trait>` の最小限利用に留め、`async/await` は原則禁止。  

## エラーハンドリング
- `std::io::Result<T>` など具体的な `Result<T, E>` を優先し、単一エラー型で完結する場合は素直にその型を返す。  
- `Result` は `?` で早期リターンし、`unwrap()` は実質 panic しない場合に限定。`expect` や独自エラー処理を優先。  
- `panic!` や `unsafe` は回避し、どうしても必要な場合のみ明示的な理由を添える。  
- `std::io::Result` と自作エラー型が混在する箇所のみ `anyhow::Result` を利用し、`anyhow!` はテストや軽微なケースに限定。  
- エラー型は `src/core/error.rs` または `src/game/error.rs` に `thiserror` で整理する。  

## テスト指針
- すべての新規/更新モジュールに正常系と境界ケースのユニットテストを追加する。  
- 入力や時間依存ロジックは `core::time` などをモック化し、副作用を検証可能にする。  
- `cargo test -- --nocapture` でログを確認し、`src/core` 配下は可能な限りテストを網羅する。  

## Git運用とPR
- `master` への直接 Push は禁止。必ず作業ブランチを切り、PR を経由してマージする。  
- 作業ブランチのコミットは、作業内容を簡潔に記述したメッセージを付ける。必要な注意点は Description に追記する。  
- PR には概要・動作確認手順・関連 Issue を記載し、入出力変更時はログやスクリーンショットを添付する。  
- ブランチ作成からマージまで、CI 成功と少なくとも1名のレビューを必須とする。  
- `master` ブランチに対する PR では GitHub Actions が Docker ビルドを実行するため、CI を通過するまで修正を継続する。  

## レビュー指針
- 命名の一貫性や Rust の慣習に沿った代替案がないか確認する。  
- 危険なロジック、特定条件での停止、ゲーム進行阻害の有無を重点的にチェックする。  
- 処理速度・リソース・可読性を改善できる場合は代案やクレート置換を提案する。  

## 運用とAIの役割
- AI は補助役として、推測ではなく明示的な指示に従う。  
- `Dockerfile` / `AGENTS.md` / `Cargo.toml` など重要ファイルの変更は提案に留め、ユーザーの確認後に反映する。  
- `Cargo.toml` の依存更新はユーザー判断で行い、必要があれば事前に相談する。  
- `Dockerfile` やプロジェクト構造に関わる破壊的変更は必ず相談し、`/review` リクエストでは診断のみを返す。  
- 明示指示がない限り新規ファイル作成・移動・改名は行わない。  
- `git` 操作はリポジトリの読み取りとコミット作成に限定し、その他の書き込み操作やデプロイは実行しない。  
